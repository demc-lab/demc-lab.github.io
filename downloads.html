<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Daily Downloads Team - Progress Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      /* UofSC palette */
      --garnet: #73000a;
      --black: #000000;
      --white: #ffffff;
      --gray-90: #363636;
      --gray-70: #5C5C5C;
      --gray-10: #ECECEC;

      /* Semantic tokens */
      --bg: #f8f5f5;
      --bg-soft: #f3eeee;
      --card-bg: #171717;
      --accent: var(--garnet);
      --accent-soft: rgba(115, 0, 10, 0.25);
      --accent-strong: #00d084;
      --text-main: #111827;
      --text-muted: #4b5563;
      --border-subtle: #d1d5db;
      --radius-lg: 16px;
      --radius-pill: 999px;
      --shadow-soft: 0 20px 40px rgba(0,0,0,0.2);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background:
        radial-gradient(circle at top left, #ffffff 0, #f9f5f5 40%, #f3eeee 80%, #ececec 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
      margin-bottom: 24px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.7rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--garnet);
    }

    .title-block p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .date-badge {
      padding: 6px 14px;
      border-radius: var(--radius-pill);
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border-subtle);
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .date-badge span:first-child {
      color: var(--garnet);
      font-size: 1rem;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 18px;
    }

    .card {
      background: linear-gradient(150deg, #73000a, #5c0008);
      border-radius: var(--radius-lg);
      border: 1px solid #4a0005;
      padding: 16px 14px 14px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.35);
      position: relative;
      overflow: hidden;
      color: #ffffff;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .name {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .name-tag {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(188,188,188,0.6);
      color: var(--gray-10);
      background: rgba(54,54,54,0.6);
    }

    .daily-target {
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: right;
    }

    .daily-target strong {
      color: #f97373;
    }

    .progress-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.85rem;
      margin-bottom: 6px;
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      border-radius: var(--radius-pill);
      background: #000000;
      overflow: hidden;
      margin-bottom: 6px;
      border: 1px solid #262626;
    }

    .progress-bar {
      height: 100%;
      width: 0;
      border-radius: var(--radius-pill);
      background: var(--garnet);
      transition: width 0.25s ease-out, background 0.25s ease-out, box-shadow 0.25s ease-out;
    }

    /* Color states for the per-person bar */
    .bar-red {
      background: linear-gradient(90deg, #73000a, #b91c1c);
      box-shadow: 0 0 8px rgba(115,0,10,0.6);
    }
    .bar-orange {
      background: linear-gradient(90deg, #ea580c, #f97316);
      box-shadow: 0 0 10px rgba(234,88,12,0.7);
    }
    .bar-yellow {
      background: linear-gradient(90deg, #eab308, #facc15);
      box-shadow: 0 0 10px rgba(234,179,8,0.7);
    }
    .bar-greenish {
      background: linear-gradient(90deg, #16a34a, #22c55e);
      box-shadow: 0 0 12px rgba(34,197,94,0.8);
    }
    .bar-green-strong {
      background: linear-gradient(90deg, #16a34a, #4ade80);
      box-shadow: 0 0 16px rgba(74,222,128,0.9);
    }
    .bar-holo {
      background: linear-gradient(120deg, #f97316, #eab308, #22c55e, #0ea5e9, #a855f7, #f97316);
      background-size: 300% 300%;
      animation: holoGlow 2s linear infinite;
      box-shadow: 0 0 20px rgba(250,250,250,0.85);
    }

    @keyframes holoGlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    button {
      border: none;
      outline: none;
      border-radius: var(--radius-pill);
      padding: 6px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition:
        transform 0.08s ease-out,
        box-shadow 0.08s ease-out,
        background 0.2s,
        opacity 0.2s;
      white-space: nowrap;
    }

    button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: none;
    }

    .btn-main {
      background: radial-gradient(circle at top, #73000a, #ba1b27);
      color: #fef2f2;
      box-shadow: 0 10px 18px rgba(115,0,10,0.5);
      border: 1px solid rgba(220,38,38,0.5);
    }

    .btn-main:hover {
      filter: brightness(1.05);
    }

    .btn-secondary {
      background: rgba(24,24,24,0.96);
      color: #f9fafb;
      border: 1px solid #4b5563;
    }

    .btn-secondary:hover {
      background: rgba(32,32,32,1);
    }

    .btn-danger {
      background: rgba(82,0,0,0.95);
      color: #fee2e2;
      border: 1px solid rgba(248,113,113,0.7);
    }

    .btn-danger:hover {
      background: rgba(127,29,29,1);
    }

    /* Go for 2500 button */
    .btn-go2500 {
      position: relative;
      overflow: hidden;
    }

    .btn-go2500.disabled {
      background: #202020;
      color: #9ca3af;
      border: 1px solid #333333;
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-go2500.enabled {
      background: linear-gradient(120deg, #f97316, #eab308, #22c55e, #0ea5e9, #a855f7, #f97316);
      background-size: 300% 300%;
      color: #050816;
      border: 1px solid #ffffff;
      animation: holoGlow 2s linear infinite;
      box-shadow: 0 0 18px rgba(255,255,255,0.7);
    }

    .btn-go2500.enabled span.emoji {
      filter: drop-shadow(0 0 4px rgba(255,255,255,0.9));
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      margin-top: 6px;
      gap: 8px;
    }

    .stat-pill {
      padding: 4px 8px;
      border-radius: var(--radius-pill);
      background: rgba(24,24,24,0.95);
      border: 1px solid #374151;
      color: #d1d5db;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .stat-pill span.value {
      color: #e5e7eb;
      font-weight: 500;
    }

    .achievements {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
      font-size: 0.7rem;
    }

    .badge {
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(55,65,81,0.8);
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(15,15,15,0.96);
    }

    .badge.on {
      border-color: rgba(34,197,94,0.9);
      background: rgba(22,163,74,0.18);
      color: #bbf7d0;
    }

    .badge strong {
      color: inherit;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: 0;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.25), transparent 60%);
      pointer-events: none;
      transition: opacity 0.3s ease-out;
    }

    .card.glow::before {
      opacity: 1;
    }

    /* Team trackers (bottom) */
    .team-trackers {
      margin-top: 32px;
      padding: 16px 14px;
      border-radius: var(--radius-lg);
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border-subtle);
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
    }

    .team-tracker {
      margin-bottom: 14px;
    }

    .team-tracker:last-child {
      margin-bottom: 0;
    }

    .team-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .team-header span.label {
      font-weight: 600;
      color: var(--garnet);
    }

    .team-header span.value {
      font-weight: 500;
      color: #111827;
    }

    .team-progress-container {
      width: 100%;
      height: 24px; /* doubled height */
      border-radius: var(--radius-pill);
      background: #e5e7eb;
      overflow: hidden;
      border: 1px solid #d1d5db;
      position: relative;
    }

    .team-progress-bar {
      height: 100%;
      width: 0;
      border-radius: var(--radius-pill);
      background: linear-gradient(
        120deg,
        #f97316,
        #eab308,
        #22c55e,
        #0ea5e9,
        #a855f7,
        #f97316
      );
      background-size: 300% 300%;
      animation: holoGlow 2s linear infinite;
      box-shadow: 0 0 16px rgba(0, 0, 0, 0.25);
      transition: width 0.25s ease-out, box-shadow 0.25s ease-out;
    }

    footer {
      margin-top: 18px;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: center;
    }

    /* Celebration overlay now fills page with confetti everywhere */
    .celebration-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      transition: opacity 0.15s ease-out;
      background: radial-gradient(circle at center, rgba(0,0,0,0.7), rgba(0,0,0,0.9));
    }

    .celebration-overlay.visible {
      opacity: 1;
    }

    .celebration-box {
      background: rgba(17,17,17,0.96);
      border-radius: 20px;
      border: 1px solid rgba(250,250,250,0.6);
      padding: 14px 20px;
      text-align: center;
      min-width: 260px;
      max-width: 340px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.95);
      position: relative;
      z-index: 2;
      color: #f9fafb;
    }

    .celebration-title {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .celebration-sub {
      display: none;
    }

    .confetti {
      position: absolute;
      font-size: 1.2rem;
      animation: confetti-fall 2.5s linear forwards;
      z-index: 1;
    }

    @keyframes confetti-fall {
      0% {
        opacity: 0;
        transform: translateY(-80px) translateX(0) rotate(0deg) scale(0.7);
      }
      10% {
        opacity: 1;
      }
      100% {
        opacity: 0;
        transform: translateY(120vh) translateX(60px) rotate(260deg) scale(1);
      }
    }

    /* Add resource link aesthetics */
    .resource-links {
      margin: 12px 0 20px;
      padding: 10px 12px;
      border-radius: var(--radius-lg);
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px 18px;
      font-size: 0.85rem;
    }

    .resource-links a {
      padding: 6px 12px;
      border-radius: var(--radius-pill);
      background: var(--garnet);
      color: #ffffff;
      text-decoration: none;
      font-weight: 500;
      border: 1px solid #4a0005;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .resource-links a:hover {
      filter: brightness(1.05);
    }
    
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title-block">
        <h1>Daily Downloads Team - Progress Panel</h1>
        <p>Log your Download Progress and Hit Your Goals Each Day.</p>
      </div>
      <div>
        <div class="date-badge">
          <span>üìÖ</span>
          <span id="current-date">Loading date‚Ä¶</span>
        </div>
      </div>
    </header>

    <p class="hint">
      Hit 2,000 downloads a day - and push for 2,500. Email Joe if you run out of downloads and need a new assignment.
    </p>

    <div class="resource-links">
      <a href="https://docs.google.com/document/d/1dyApmwqCAarkQZimU1CVon85t1lV7U2Z/edit" target="_blank" rel="noopener noreferrer">
        Download Instructions
      </a>
      <a href="https://guides.library.sc.edu/c.php?g=410318&p=2797667" target="_blank" rel="noopener noreferrer">
        Link to LexisNexis
      </a>
      <a href="https://docs.google.com/spreadsheets/d/1HvGiz47HTLl6YYt78p3ynjxy_t47A5R_/edit?gid=1212352806#gid=1212352806"
         target="_blank" rel="noopener noreferrer">
        Download Assignments
      </a>
      <a href="https://drive.google.com/drive/folders/1LIPT75mm_4_53jGq3P-KkWPsqt9NIQ0S" target="_blank" rel="noopener noreferrer">
        Articles Upload Folder
      </a>
      <a href="https://drive.google.com/drive/folders/1ZfXeOZY3cAxNaKIdix8WJS2TzlS7ik81" target="_blank" rel="noopener noreferrer">
        Metadata Upload Folder (Josh)
      </a>
    </div>
  </div>

    <div class="grid" id="cards-container">
      <!-- Cards injected by JS -->
    </div>

    <div class="team-trackers">
      <div class="team-tracker">
        <div class="team-header">
          <span class="label">Team Daily Progress (resets at midnight)</span>
          <span class="value team-daily-label">0 / 15,000</span>
        </div>
        <div class="team-progress-container">
          <div class="team-progress-bar team-daily-bar"></div>
        </div>
      </div>
      <div class="team-tracker">
        <div class="team-header">
          <span class="label">Team Weekly Progress (resets Sunday 12:00am)</span>
          <span class="value team-weekly-label">0 / 105,000</span>
        </div>
        <div class="team-progress-container">
          <div class="team-progress-bar team-weekly-bar"></div>
        </div>
      </div>
      <div class="team-tracker">
        <div class="team-header">
          <span class="label">Team Lifetime Progress (toward 1,750,000 downloads)</span>
          <span class="value team-lifetime-label">0 / 1,750,000</span>
        </div>
        <div class="team-progress-container">
          <div class="team-progress-bar team-lifetime-bar"></div>
        </div>
      </div>
    </div>

    <footer>
      Tip: Keep this tab open and tap <strong>+250</strong> as you complete batches.
      Hit <strong>2000</strong> to unlock the <strong>‚ÄúGo for 2500‚Äù</strong> booster.
    </footer>

  <!-- Celebration overlay -->
  <div class="celebration-overlay" id="celebration">
    <div class="celebration-box">
      <div class="celebration-title" id="celebration-title">Nice!</div>
      <div class="celebration-sub" id="celebration-sub"></div>
    </div>
  </div>
  <script>
    /***********************
     * CONFIGURE STUDENTS  *
     ***********************/
    const initialStudents = [
      { id: "aaron", name: "Aaron" },
      { id: "gabby", name: "Gabby" },
      { id: "hazel", name: "Hazel" },
      { id: "josh", name: "Josh" },
      { id: "paige", name: "Paige" },
      { id: "joe", name: "Joe" }
    ];

    const DAILY_GOAL = 2000;
    const DAILY_MAX = 2500;
    const SESSION_SIZE = 500;

    const DAILY_TEAM_TARGET = 15000;   // 6 √ó 2500
    const WEEKLY_TARGET = 105000;      // 7 √ó 15000
    const LIFETIME_TARGET = 1750000;
    const LIFETIME_OFFSET = 320000;

    // üîë Your Apps Script Web App URL:
    const API_URL = "YOUR_WEB_APP_URL_HERE";

    // In-memory state, built from backend response
    let appState = null;

    /***********************
     * UTILITIES           *
     ***********************/
    function todayString() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function formatNiceDate(dateStr) {
      if (!dateStr) return "";
      const parts = dateStr.split("-");
      if (parts.length !== 3) return dateStr;
      const [y, m, d] = parts.map(Number);
      const dt = new Date(y, m - 1, d);
      if (Number.isNaN(dt.getTime())) return dateStr;
      return dt.toLocaleDateString(undefined, {
        weekday: "short",
        month: "short",
        day: "numeric"
      });
    }

    function renderDate(dateStr) {
      const el = document.getElementById("current-date");
      if (!el) return;
      const toUse = dateStr || todayString();
      el.textContent = formatNiceDate(toUse);
    }

    /***********************
     * BACKEND INTERFACE   *
     ***********************/
    async function fetchStateFromServer() {
      const res = await fetch(API_URL, { method: "GET" });
      if (!res.ok) throw new Error("Failed to fetch state");
      const data = await res.json();

      const students = {};
      initialStudents.forEach(s => {
        const src = (data.students && data.students[s.id]) || {};
        students[s.id] = {
          id: s.id,
          name: s.name,
          todayDocs: src.todayDocs || 0,
          lifetimeDocs: src.lifetimeDocs || 0,
          daysHitGoal: src.daysHitGoal || 0,
          daysHitMax: src.daysHitMax || 0,
          streakSessionsToday: 0  // for celebrations only, not persisted
        };
      });

      const team = {
        dailyDocs: (data.team && data.team.dailyDocs) || 0,
        weeklyDocs: (data.team && data.team.weeklyDocs) || 0,
        lifetimeDocs: (data.team && data.team.lifetimeDocs) || LIFETIME_OFFSET
      };

      appState = {
        today: data.today || todayString(),
        students,
        team
      };

      renderDate(appState.today);
      renderAll();
    }

    async function logDeltaToServer(studentId, delta) {
      try {
        await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ studentId, delta })
        });
      } catch (err) {
        console.error("Error logging delta:", err);
      }
    }

    /***********************
     * CARD CREATION       *
     ***********************/
    function createCard(stu) {
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.studentId = stu.id;

      card.innerHTML = `
        <div class="card-header">
          <div class="name">
            <span>${stu.name}</span>
            <span class="name-tag">${stu.id === "joe" ? "PI" : "RA"}</span>
          </div>
          <div class="daily-target">
            Target: <strong>${DAILY_GOAL.toLocaleString()}</strong><br>
            Max: <strong>${DAILY_MAX.toLocaleString()}</strong>
          </div>
        </div>
        <div class="progress-row">
          <div>Today: <strong><span class="today-docs">${stu.todayDocs}</span> / ${DAILY_MAX.toLocaleString()}</strong></div>
          <div style="font-size:0.8rem;color:#9ca3af;">
            Sessions: <span class="today-sessions">${Math.floor(stu.todayDocs / SESSION_SIZE)}</span>
          </div>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar"></div>
        </div>
        <div class="progress-labels">
          <span>0</span>
          <span>${DAILY_GOAL.toLocaleString()} (goal)</span>
          <span>${DAILY_MAX.toLocaleString()} (max)</span>
        </div>
        <div class="buttons">
          <button class="btn-main" data-inc="250">+250</button>
          <button class="btn-go2500 disabled" data-go2500="true">
            <span class="emoji">üöÄ</span>
            <span class="label">Go for 2500</span>
          </button>
          <button class="btn-danger" data-dec="250">-250</button>
        </div>
        <div class="stats-row">
          <span class="stat-pill">
            üîÅ Sessions today:
            <span class="value today-sessions-pill">${Math.floor(stu.todayDocs / SESSION_SIZE)}</span>
          </span>
          <span class="stat-pill">
            üìö Lifetime: <span class="value lifetime-docs">${stu.lifetimeDocs}</span>
          </span>
        </div>
        <div class="achievements">
          <span class="badge badge-goal">
            üèÜ <strong class="goal-days">${stu.daysHitGoal}</strong> days ‚â• ${DAILY_GOAL}
          </span>
          <span class="badge badge-max">
            üåü <strong class="max-days">${stu.daysHitMax}</strong> days ‚â• ${DAILY_MAX}
          </span>
        </div>
      `;

      const buttons = card.querySelectorAll("button");
      buttons.forEach(btn => {
        if (btn.dataset.inc) {
          btn.addEventListener("click", () =>
            changeDocs(stu.id, parseInt(btn.dataset.inc, 10))
          );
        } else if (btn.dataset.dec) {
          btn.addEventListener("click", () =>
            changeDocs(stu.id, -parseInt(btn.dataset.dec, 10))
          );
        } else if (btn.dataset.go2500) {
          btn.addEventListener("click", () => handleGoFor2500(stu.id));
        }
      });

      return card;
    }

    function renderAll() {
      if (!appState) return;
      const container = document.getElementById("cards-container");
      if (!container) return;

      // Rebuild the grid each time for simplicity
      container.innerHTML = "";
      initialStudents.forEach(s => {
        const stu = appState.students[s.id];
        const card = createCard(stu);
        container.appendChild(card);
        updateCardVisuals(stu.id);
      });

      updateTeamTrackers();
    }

    /***********************
     * VISUAL UPDATES      *
     ***********************/
    function updateBarColor(barEl, docs) {
      barEl.classList.remove(
        "bar-red",
        "bar-orange",
        "bar-yellow",
        "bar-greenish",
        "bar-green-strong",
        "bar-holo"
      );

      if (docs >= DAILY_MAX) {
        barEl.classList.add("bar-holo");
      } else if (docs >= 2000) {
        barEl.classList.add("bar-green-strong");
      } else if (docs >= 1500) {
        barEl.classList.add("bar-greenish");
      } else if (docs >= 1000) {
        barEl.classList.add("bar-yellow");
      } else if (docs >= 500) {
        barEl.classList.add("bar-orange");
      } else {
        barEl.classList.add("bar-red");
      }
    }

    function updateGo2500Button(card, docs) {
      const btn = card.querySelector(".btn-go2500");
      if (!btn) return;

      const label = btn.querySelector(".label");

      if (docs < DAILY_GOAL) {
        btn.classList.remove("enabled");
        btn.classList.add("disabled");
        btn.setAttribute("aria-disabled", "true");
        if (label) label.textContent = "Locked ‚Äì reach 2000";
        btn.title = "This unlocks once you log at least 2000 downloads today.";
      } else if (docs >= DAILY_MAX) {
        btn.classList.remove("enabled");
        btn.classList.add("disabled");
        btn.setAttribute("aria-disabled", "true");
        if (label) label.textContent = "Max achieved";
        btn.title = "You‚Äôve already hit the 2500 max for today.";
      } else {
        btn.classList.remove("disabled");
        btn.classList.add("enabled");
        btn.removeAttribute("aria-disabled");
        if (label) label.textContent = "Unlocked ‚Äì push for 2500";
        btn.title = "You‚Äôve hit 2000 ‚Äì click to celebrate your push to 2500.";
      }
    }

    function updateCardVisuals(studentId) {
      if (!appState) return;
      const stu = appState.students[studentId];
      const card = document.querySelector(`.card[data-student-id="${studentId}"]`);
      if (!card || !stu) return;

      const todayDocsEl = card.querySelector(".today-docs");
      const todaySesEl = card.querySelector(".today-sessions");
      const todaySesPill = card.querySelector(".today-sessions-pill");
      const lifetimeEl = card.querySelector(".lifetime-docs");
      const bar = card.querySelector(".progress-bar");
      const badgeGoal = card.querySelector(".badge-goal");
      const badgeMax = card.querySelector(".badge-max");
      const goalDaysEl = card.querySelector(".goal-days");
      const maxDaysEl = card.querySelector(".max-days");

      const sessions = Math.floor(stu.todayDocs / SESSION_SIZE);
      const pct = Math.min(100, (stu.todayDocs / DAILY_MAX) * 100);

      if (todayDocsEl) todayDocsEl.textContent = stu.todayDocs;
      if (todaySesEl) todaySesEl.textContent = sessions;
      if (todaySesPill) todaySesPill.textContent = sessions;
      if (lifetimeEl) lifetimeEl.textContent = stu.lifetimeDocs;

      if (goalDaysEl) goalDaysEl.textContent = stu.daysHitGoal;
      if (maxDaysEl) maxDaysEl.textContent = stu.daysHitMax;

      if (bar) {
        bar.style.width = pct + "%";
        updateBarColor(bar, stu.todayDocs);
      }

      updateGo2500Button(card, stu.todayDocs);

      if (badgeGoal) {
        if (stu.todayDocs >= DAILY_GOAL) badgeGoal.classList.add("on");
        else badgeGoal.classList.remove("on");
      }
      if (badgeMax) {
        if (stu.todayDocs >= DAILY_MAX) badgeMax.classList.add("on");
        else badgeMax.classList.remove("on");
      }
    }

    function updateTeamTrackers() {
      if (!appState) return;

      const dailyLabel = document.querySelector(".team-daily-label");
      const dailyBar = document.querySelector(".team-daily-bar");
      const weeklyLabel = document.querySelector(".team-weekly-label");
      const weeklyBar = document.querySelector(".team-weekly-bar");
      const lifetimeLabel = document.querySelector(".team-lifetime-label");
      const lifetimeBar = document.querySelector(".team-lifetime-bar");

      if (!dailyLabel || !dailyBar || !weeklyLabel || !weeklyBar || !lifetimeLabel || !lifetimeBar) return;

      const dailyDocs = appState.team.dailyDocs || 0;
      const weeklyDocs = appState.team.weeklyDocs || 0;
      const lifetimeDocs = appState.team.lifetimeDocs || LIFETIME_OFFSET;

      dailyLabel.textContent = `${dailyDocs.toLocaleString()} / ${DAILY_TEAM_TARGET.toLocaleString()}`;
      weeklyLabel.textContent = `${weeklyDocs.toLocaleString()} / ${WEEKLY_TARGET.toLocaleString()}`;
      lifetimeLabel.textContent = `${lifetimeDocs.toLocaleString()} / ${LIFETIME_TARGET.toLocaleString()}`;

      const dailyPctRaw = (dailyDocs / DAILY_TEAM_TARGET) * 100;
      const weeklyPctRaw = (weeklyDocs / WEEKLY_TARGET) * 100;
      const lifetimePctRaw = (lifetimeDocs / LIFETIME_TARGET) * 100;

      const dailyPct = dailyDocs > 0 ? Math.min(100, Math.max(4, dailyPctRaw)) : 0;
      const weeklyPct = weeklyDocs > 0 ? Math.min(100, Math.max(4, weeklyPctRaw)) : 0;
      const lifetimePct = lifetimeDocs > 0 ? Math.min(100, Math.max(4, lifetimePctRaw)) : 0;

      dailyBar.style.width = dailyPct + "%";
      weeklyBar.style.width = weeklyPct + "%";
      lifetimeBar.style.width = lifetimePct + "%";

      dailyBar.classList.remove("bar-holo");
      weeklyBar.classList.remove("bar-holo");
      lifetimeBar.classList.remove("bar-holo");

      if (dailyDocs >= DAILY_TEAM_TARGET) dailyBar.classList.add("bar-holo");
      if (weeklyDocs >= WEEKLY_TARGET) weeklyBar.classList.add("bar-holo");
      if (lifetimeDocs >= LIFETIME_TARGET) lifetimeBar.classList.add("bar-holo");
    }

    /***********************
     * ACTION HANDLERS     *
     ***********************/
    function changeDocs(studentId, delta) {
      if (!appState) return;
      const stu = appState.students[studentId];
      if (!stu) return;

      const prevDocs = stu.todayDocs;
      let newDocs = prevDocs + delta;
      if (newDocs < 0) newDocs = 0;
      if (newDocs > DAILY_MAX) newDocs = DAILY_MAX;

      const effectiveDelta = newDocs - prevDocs;
      if (effectiveDelta === 0) return;

      stu.todayDocs = newDocs;
      stu.lifetimeDocs = (stu.lifetimeDocs || 0) + effectiveDelta;

      // Update team counts optimistically
      appState.team.dailyDocs = (appState.team.dailyDocs || 0) + effectiveDelta;
      appState.team.weeklyDocs = (appState.team.weeklyDocs || 0) + effectiveDelta;
      appState.team.lifetimeDocs = (appState.team.lifetimeDocs || LIFETIME_OFFSET) + effectiveDelta;

      const prevSessions = Math.floor(prevDocs / SESSION_SIZE);
      const newSessions = Math.floor(newDocs / SESSION_SIZE);
      if (newSessions > prevSessions && effectiveDelta > 0) {
        stu.streakSessionsToday = (stu.streakSessionsToday || 0) + (newSessions - prevSessions);
        triggerCelebration("session", stu.name, stu.streakSessionsToday);
      }

      const crossedGoal = prevDocs < DAILY_GOAL && newDocs >= DAILY_GOAL;
      const crossedMax = prevDocs < DAILY_MAX && newDocs >= DAILY_MAX;

      if (crossedGoal) {
        triggerCelebration("goal", stu.name);
      }
      if (crossedMax) {
        triggerCelebration("max", stu.name);
      }

      updateCardVisuals(studentId);
      updateTeamTrackers();

      // Log this change to the backend
      logDeltaToServer(studentId, effectiveDelta);
    }

    function handleGoFor2500(studentId) {
      if (!appState) return;
      const stu = appState.students[studentId];
      if (!stu || stu.todayDocs < DAILY_GOAL) return;
      triggerCelebration("go2500", stu.name, Math.floor(stu.todayDocs / SESSION_SIZE));
    }

    /***********************
     * CELEBRATION EFFECTS *
     ***********************/
    const celebrationEl = document.getElementById("celebration");
    const celebrationTitle = document.getElementById("celebration-title");
    const celebrationSub = document.getElementById("celebration-sub");

    function triggerCelebration(type, name, streakCount) {
      if (!celebrationEl || !celebrationTitle || !celebrationSub) return;

      let title = "";
      let sub = "";
      let confettiEmojis = [];

      if (type === "session") {
        const intensifiers = [
          "Session complete!",
          "Double session!",
          "Triple threat!",
          "Four in a row! üî•",
          "You‚Äôre on fire! üî•üî•",
          "Download machine! ü§ñ"
        ];
        const idx = Math.min((streakCount || 1) - 1, intensifiers.length - 1);
        title = `${name}: ${intensifiers[idx]}`;
        sub = `You just completed another ${SESSION_SIZE} articles. Total sessions today: ${streakCount || "?"}.`;
        confettiEmojis = ["‚ú®", "üìÑ", "‚ö°Ô∏è", "üíæ"];
      } else if (type === "goal") {
        title = `${name} hit the daily goal! üèÜ`;
        sub = `üéØ ${DAILY_GOAL.toLocaleString()} articles downloaded today.`;
        confettiEmojis = ["üèÜ", "üéâ", "üìö", "üöÄ"];
      } else if (type === "max") {
        title = `${name} maxed out the system! üåü`;
        sub = `Legend status: ${DAILY_MAX.toLocaleString()} articles in a single day.`;
        confettiEmojis = ["üåü", "ü§Ø", "üî•", "üéä"];
      } else if (type === "go2500") {
        title = `${name}, go for 2500! üöÄ`;
        sub = `You‚Äôve hit the goal. One more push to ${DAILY_MAX.toLocaleString()} ‚Äì you‚Äôve got this.`;
        confettiEmojis = ["üöÄ", "üìà", "‚ú®", "üî•"];
      }

      celebrationTitle.textContent = title;
      celebrationSub.textContent = "";

      const old = celebrationEl.querySelectorAll(".confetti");
      old.forEach(el => el.remove());

      const totalConfetti = 40;
      const overlayRect = celebrationEl.getBoundingClientRect();
      for (let i = 0; i < totalConfetti; i++) {
        const span = document.createElement("span");
        span.className = "confetti";
        span.textContent = confettiEmojis[i % confettiEmojis.length];

        const startX = Math.random() * overlayRect.width;
        const startY = Math.random() * 80 - 40;
        span.style.left = `${startX}px`;
        span.style.top = `${startY}px`;
        span.style.animationDelay = (Math.random() * 0.5).toFixed(2) + "s";

        celebrationEl.appendChild(span);
      }

      celebrationEl.classList.add("visible");
      setTimeout(() => {
        celebrationEl.classList.remove("visible");
      }, 2500); // 2.5 seconds
    }

    /***********************
     * INIT                *
     ***********************/
    async function init() {
      renderDate("Loading...");
      try {
        await fetchStateFromServer();
      } catch (err) {
        console.error("Initial fetch failed:", err);
        renderDate(todayString());
      }

      // Periodic refresh to pick up others' progress
      setInterval(() => {
        fetchStateFromServer().catch(err =>
          console.error("Periodic refresh failed:", err)
        );
      }, 120000); // every 2 minutes
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
